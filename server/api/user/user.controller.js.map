{"version":3,"sources":["api/user/user.controller.js"],"names":["index","create","show","destroy","changePassword","me","authCallback","validationError","res","statusCode","err","status","json","handleError","send","respondWithResult","entity","req","find","exec","then","users","catch","body","rollNumber","split","join","toLowerCase","findOne","team","$elemMatch","newUser","house","length","_id","provider","role","save","user","token","sign","secrets","session","expiresIn","next","userId","params","id","findById","end","profile","findByIdAndRemove","oldPass","String","oldPassword","newPass","newPassword","authenticate","password","populate","redirect"],"mappings":"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","file":"api/user/user.controller.js","sourcesContent":["'use strict';\n\nimport User from './user.model';\nimport House from '../house/house.model';\nimport config from '../../config/environment';\nimport jwt from 'jsonwebtoken';\n\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function(err) {\n    return res.status(statusCode).json(err);\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    return res.status(statusCode).send(err);\n  };\n}\n\nfunction respondWithResult(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function(entity) {\n    if(entity) {\n      return res.status(statusCode).json(entity);\n    }\n    return null;\n  };\n}\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexport function index(req, res) {\n  return User.find({}, '-salt -password').exec()\n    .then(users => {\n      res.status(200).json(users);\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Creates a new user\n */\nexport function create(req, res) {\n\n  if(req.body.rollNumber)\n    var rollNumber = req.body.rollNumber.split(' ');\n    rollNumber = rollNumber.join('').toLowerCase();\n    House.findOne({ team: { $elemMatch: req.body.rollNumber}})\n    .exec()\n    .then(house=>{\n\n      var newUser = new User(req.body);\n\n      if(house.length)\n        newUser.house = house._id;\n\n      newUser.provider = 'local';\n      newUser.role = 'user';\n      newUser.save()\n        .then(function(user) {\n          var token = jwt.sign({ _id: user._id }, config.secrets.session, {\n            expiresIn: 60 * 60 * 5\n          });\n          res.json({ token });\n        })\n        .catch(validationError(res));\n    })\n}\n\n/**\n * Get a single user\n */\nexport function show(req, res, next) {\n  var userId = req.params.id;\n\n  return User.findById(userId).exec()\n    .then(user => {\n      if(!user) {\n        return res.status(404).end();\n      }\n      res.json(user.profile);\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Deletes a user\n * restriction: 'admin'\n */\nexport function destroy(req, res) {\n  return User.findByIdAndRemove(req.params.id).exec()\n    .then(function() {\n      res.status(204).end();\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Change a users password\n */\nexport function changePassword(req, res) {\n  var userId = req.user._id;\n  var oldPass = String(req.body.oldPassword);\n  var newPass = String(req.body.newPassword);\n\n  return User.findById(userId).exec()\n    .then(user => {\n      if(user.authenticate(oldPass)) {\n        user.password = newPass;\n        return user.save()\n          .then(() => {\n            res.status(204).end();\n          })\n          .catch(validationError(res));\n      } else {\n        return res.status(403).end();\n      }\n    });\n}\n\n/**\n * Get my info\n */\nexport function me(req, res, next) {\n  var userId = req.user._id;\n\n  return User.findOne({ _id: userId }, '-salt -password').populate('house').exec()\n    .then(user => { // don't ever give out the password or salt\n      if(!user) {\n        return res.status(401).end();\n      }\n      res.json(user);\n    })\n    .catch(err => next(err));\n}\n/**\n * Authentication callback\n */\nexport function authCallback(req, res) {\n  res.redirect('/');\n}\n"],"sourceRoot":"/source/"}